# React 合成事件 (SyntheticEvent) 详解

React 的**合成事件 (SyntheticEvent)** 是一套**模拟 DOM 原生事件**的机制。它抹平了浏览器差异，优化了性能，并随着 React 版本的迭代经历了重大重构。

## 1. 什么是合成事件？

在 React 中，`onClick`、`onChange` 等事件并不是直接绑定到真实 DOM 上的原生事件，而是 React 封装的 **合成事件对象**。

### 核心设计目的

1. **跨浏览器兼容**：抹平 IE 和现代浏览器的差异（如 `e.stopPropagation` 与 `cancelBubble`）。
2. **性能优化 (事件委托)**：避免在成千上万个子节点上绑定监听器，而是利用**事件委托**技术，统一在根节点处理。

---

## 2. 工作原理：事件委托与模拟

React 的事件系统主要分为两个阶段：

### 2.1 绑定阶段 (Delegation)

React 不会把事件绑定到具体的 DOM 元素（如 `<button>`）上。

* React 启动时，会在 **根容器 (Root)** 上统一监听所有支持的原生事件（`click`, `input`, `keydown` 等）。

### 2.2 触发阶段 (Simulation)

当用户点击页面元素时：

1. **原生冒泡**：浏览器原生事件从点击目标冒泡到 Root 节点。
2. **React 拦截**：Root 节点上的监听器捕获该事件。
3. **构造对象**：React 根据原生事件 (`nativeEvent`) 创建 `SyntheticEvent` 对象。
4. **收集路径**：React 根据 `nativeEvent.target` 找到对应的 Fiber 节点，向上遍历组件树，收集所有 `onClick` / `onClickCapture` 回调。
5. **模拟执行**：
    * 先执行捕获队列（父 -> 子）。
    * 后执行冒泡队列（子 -> 父）。

---

## 3. 版本差异：React 16 vs React 17+

React 17 对事件系统进行了大刀阔斧的改革，主要解决了两个痛点：**微前端/多版本共存冲突** 和 **异步访问失效**。

### 3.1 差异一：事件委托挂载点 (Delegation Root)

* **React 16**：绑定在 **`document`** 上。
  * **痛点**：如果页面上有多个 React 应用（微前端），或者混用 jQuery。当内部应用调用 `e.stopPropagation()` 时，只能阻止 React 内部冒泡，无法阻止原生事件冒泡到 `document`。导致外部应用依然会收到事件。
* **React 17+**：绑定在 **React Root 容器** (如 `#app`) 上。
  * **优势**：事件仅在当前nn React 应用的 DOM 树内传播，互不干扰，更安全。

### 3.2 差异二：事件池 (Event Pooling)

* **React 16**：**有事件池**。
  * **机制**：为了省内存，事件对象会被复用。回调执行完后，属性会被立即清空（设为 null）。
  * **痛点**：在 `setTimeout` 或 `Promise` 中访问 `e.target` 会得到 `null`。必须手动调用 `e.persist()` 才能保留。
* **React 17+**：**移除事件池**。
  * **机制**：每次触发都 `new` 一个新对象，用完交给 JS 引擎垃圾回收。
  * **优势**：符合直觉，异步代码中可以放心使用事件对象，`e.persist()` 变为空函数。

### 3.3 差异三：捕获阶段的实现 (Capture Phase)

* **React 16**：**“伪捕获”**。
  * React 仅绑定原生**冒泡**监听器。
  * `onClickCapture` 是 React 在收到冒泡事件后，自己模拟出来的执行顺序。
  * **痛点**：如果原生 DOM 阻止了冒泡，React 连捕获事件都收不到。
* **React 17+**：**“真捕获”**。
  * React 会在 Root 上绑定真正的原生**捕获**监听器。
  * **优势**：即使原生冒泡被阻断，React 的捕获事件依然能正常触发。

---

## 4. 总结对比表

| 特性 | React 16 | React 17 / 18 / 19 | 改进意义 |
| :--- | :--- | :--- | :--- |
| **绑定位置** | `document` | `root` 容器 DOM | 支持微前端，多应用隔离 |
| **事件池** | 有 (Pooling) | 无 (No Pooling) | 修复异步访问 `e` 属性为 null 的坑 |
| **异步访问** | 需调用 `e.persist()` | 直接访问 | 降低心智负担 |
| **捕获实现** | 模拟 (基于冒泡) | 原生捕获监听 | 修复原生阻止冒泡导致 React 捕获失效的 Bug |
