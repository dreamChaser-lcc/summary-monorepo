var sdkName=function(o,a){"use strict";class g{constructor(e,t){this.ws=null,this.events={},this.state="disconnected",this.reconnectAttempts=0,this.heartbeatTimer=null,this.reconnectTimer=null,this.messageQueue=[],this.pendingMessages=new Map,this.failedQueue=[],this.retryTimer=null,this.config={reconnectInterval:3e3,maxReconnectAttempts:5,heartbeatInterval:3e4,messageTimeout:1e4,maxRetryCount:3,retryDelay:2e3,enableHeartbeat:!0,enableQueue:!0,debug:!1,protocols:void 0,...e},this.events=t||{},this.log("WebSocket \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u5B8C\u6210")}async connect(){return new Promise((e,t)=>{try{this.log("\u5F00\u59CB\u8FDE\u63A5 WebSocket:",this.config.url),this.setState("connecting"),this.ws=new WebSocket(this.config.url,this.config.protocols),this.ws.onopen=s=>{this.log("WebSocket \u8FDE\u63A5\u6210\u529F"),this.setState("connected"),this.reconnectAttempts=0,this.startHeartbeat(),this.processMessageQueue(),this.processFailedQueue(),this.events.onOpen?.(s),e()},this.ws.onmessage=s=>{this.handleMessage(s)},this.ws.onerror=s=>{this.log("WebSocket \u9519\u8BEF:",s),this.events.onError?.(s),t(new Error("WebSocket \u8FDE\u63A5\u5931\u8D25"))},this.ws.onclose=s=>{this.log("WebSocket \u8FDE\u63A5\u5173\u95ED:",s.code,s.reason),this.setState("disconnected"),this.stopHeartbeat(),this.events.onClose?.(s),s.code!==1e3&&this.reconnectAttempts<this.config.maxReconnectAttempts?this.scheduleReconnect():this.reconnectAttempts>=this.config.maxReconnectAttempts&&(this.setState("failed"),this.events.onMaxReconnectReached?.())}}catch(s){this.log("\u8FDE\u63A5\u5931\u8D25:",s),t(s)}})}disconnect(){this.log("\u4E3B\u52A8\u65AD\u5F00 WebSocket \u8FDE\u63A5"),this.clearTimers(),this.ws&&(this.ws.close(1e3,"\u4E3B\u52A8\u65AD\u5F00"),this.ws=null),this.setState("disconnected")}async send(e,t){const s={id:this.generateId(),type:e,data:t,timestamp:Date.now()};return new Promise((u,n)=>{if(this.state!=="connected")if(this.config.enableQueue){this.log("\u8FDE\u63A5\u672A\u5C31\u7EEA\uFF0C\u6D88\u606F\u52A0\u5165\u961F\u5217:",s.id),this.messageQueue.push(s),this.pendingMessages.set(s.id,{resolve:u,reject:n,timer:setTimeout(()=>{this.pendingMessages.delete(s.id),n(new Error("\u6D88\u606F\u53D1\u9001\u8D85\u65F6"))},this.config.messageTimeout)});return}else{n(new Error("WebSocket \u672A\u8FDE\u63A5"));return}try{this.ws.send(JSON.stringify(s)),this.log("\u6D88\u606F\u53D1\u9001\u6210\u529F:",s.id,e);const i=setTimeout(()=>{this.pendingMessages.delete(s.id),n(new Error("\u6D88\u606F\u54CD\u5E94\u8D85\u65F6"))},this.config.messageTimeout);this.pendingMessages.set(s.id,{resolve:u,reject:n,timer:i})}catch(i){this.log("\u6D88\u606F\u53D1\u9001\u5931\u8D25:",i),this.addToFailedQueue(s),n(i)}})}sendNoResponse(e,t){const s={id:this.generateId(),type:e,data:t,timestamp:Date.now()};if(this.state!=="connected")if(this.config.enableQueue){this.messageQueue.push(s);return}else throw new Error("WebSocket \u672A\u8FDE\u63A5");try{this.ws.send(JSON.stringify(s)),this.log("\u5355\u5411\u6D88\u606F\u53D1\u9001\u6210\u529F:",s.id,e)}catch(u){throw this.log("\u5355\u5411\u6D88\u606F\u53D1\u9001\u5931\u8D25:",u),this.addToFailedQueue(s),u}}handleMessage(e){try{const t=JSON.parse(e.data);if(this.log("\u6536\u5230\u6D88\u606F:",t.id,t.type),t.type==="pong")return;if(this.pendingMessages.has(t.id)){const s=this.pendingMessages.get(t.id);clearTimeout(s.timer),this.pendingMessages.delete(t.id),s.resolve(t.data);return}this.events.onMessage?.(t)}catch(t){this.log("\u6D88\u606F\u89E3\u6790\u5931\u8D25:",t)}}scheduleReconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectAttempts++,this.setState("reconnecting"),this.log(`\u51C6\u5907\u7B2C ${this.reconnectAttempts} \u6B21\u91CD\u8FDE...`),this.reconnectTimer=setTimeout(async()=>{try{this.events.onReconnect?.(this.reconnectAttempts),await this.connect()}catch(e){this.log("\u91CD\u8FDE\u5931\u8D25:",e)}},this.config.reconnectInterval)}startHeartbeat(){this.config.enableHeartbeat&&(this.heartbeatTimer=setInterval(()=>{this.state==="connected"&&this.sendNoResponse("ping",{timestamp:Date.now()})},this.config.heartbeatInterval))}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}processMessageQueue(){if(!this.config.enableQueue||this.messageQueue.length===0)return;this.log(`\u5904\u7406\u6D88\u606F\u961F\u5217\uFF0C\u5171 ${this.messageQueue.length} \u6761\u6D88\u606F`);const e=[...this.messageQueue];this.messageQueue=[],e.forEach(t=>{try{this.ws.send(JSON.stringify(t)),this.log("\u961F\u5217\u6D88\u606F\u53D1\u9001\u6210\u529F:",t.id)}catch(s){this.log("\u961F\u5217\u6D88\u606F\u53D1\u9001\u5931\u8D25:",s),this.addToFailedQueue(t)}})}addToFailedQueue(e){const t=(e.retryCount||0)+1;t<=this.config.maxRetryCount?(this.failedQueue.push({message:{...e,retryCount:t},retryCount:t,lastAttempt:Date.now()}),this.log(`\u6D88\u606F\u52A0\u5165\u5931\u8D25\u961F\u5217\uFF0C\u91CD\u8BD5\u6B21\u6570: ${t}/${this.config.maxRetryCount}`),this.scheduleRetry()):this.log("\u6D88\u606F\u91CD\u8BD5\u6B21\u6570\u8D85\u9650\uFF0C\u4E22\u5F03:",e.id)}scheduleRetry(){this.retryTimer||(this.retryTimer=setTimeout(()=>{this.processFailedQueue(),this.retryTimer=null},this.config.retryDelay))}processFailedQueue(){if(this.failedQueue.length===0||this.state!=="connected")return;this.log(`\u5904\u7406\u5931\u8D25\u961F\u5217\uFF0C\u5171 ${this.failedQueue.length} \u6761\u6D88\u606F`);const e=[...this.failedQueue];this.failedQueue=[],e.forEach(t=>{try{this.ws.send(JSON.stringify(t.message)),this.log("\u5931\u8D25\u961F\u5217\u6D88\u606F\u91CD\u8BD5\u6210\u529F:",t.message.id)}catch(s){this.log("\u5931\u8D25\u961F\u5217\u6D88\u606F\u91CD\u8BD5\u5931\u8D25:",s),this.addToFailedQueue(t.message)}})}setState(e){this.state!==e&&(this.state=e,this.log("\u72B6\u6001\u53D8\u66F4:",e),this.events.onStateChange?.(e))}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}clearTimers(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}log(...e){this.config.debug&&console.log("[WebSocket]",...e)}getState(){return this.state}getQueueInfo(){return{messageQueue:this.messageQueue.length,pendingMessages:this.pendingMessages.size,failedQueue:this.failedQueue.length,reconnectAttempts:this.reconnectAttempts}}clearQueues(){this.messageQueue=[],this.failedQueue=[],this.pendingMessages.forEach(e=>{clearTimeout(e.timer),e.reject(new Error("\u961F\u5217\u5DF2\u6E05\u7A7A"))}),this.pendingMessages.clear(),this.log("\u6240\u6709\u961F\u5217\u5DF2\u6E05\u7A7A")}}class m{constructor(e=10){this.pending=new Map,this.currentRequests=0,this.queue=[],this.maxConcurrent=e}generateRequestKey(e){const{method:t,url:s,params:u,data:n}=e;return`${t}:${s}:${JSON.stringify(u)}:${JSON.stringify(n)}`}cancelDuplicateRequest(e){const t=this.generateRequestKey(e);this.pending.has(t)&&(this.pending.get(t).abort("\u53D6\u6D88\u91CD\u590D\u8BF7\u6C42"),this.pending.delete(t));const s=new AbortController;e.signal=s.signal,this.pending.set(t,s)}removePendingRequest(e){const t=this.generateRequestKey(e);this.pending.delete(t)}async controlConcurrency(e){return new Promise((t,s)=>{const u=async()=>{if(this.currentRequests>=this.maxConcurrent){this.queue.push(u);return}this.currentRequests++;try{const n=await e();t(n)}catch(n){s(n)}finally{this.currentRequests--,this.queue.length>0&&this.queue.shift()()}};u()})}cancelAllRequests(){this.pending.forEach(e=>{e.abort("\u53D6\u6D88\u6240\u6709\u8BF7\u6C42")}),this.pending.clear(),this.queue.length=0}}class c{constructor(e={}){this.defaultConfig={timeout:1e4,retry:3,retryDelay:1e3,showLoading:!1,...e},this.concurrencyManager=new m(10),this.instance=a.create(this.defaultConfig),this.setupInterceptors()}setupInterceptors(){this.instance.interceptors.request.use(e=>{this.concurrencyManager.cancelDuplicateRequest(e);const t=this.getToken();return t&&(e.headers.Authorization=`Bearer ${t}`),e.metadata={startTime:Date.now()},e.showLoading&&this.showLoading(),console.log(`\u{1F680} \u8BF7\u6C42\u53D1\u9001: ${e.method?.toUpperCase()} ${e.url}`),e},e=>(console.error("\u274C \u8BF7\u6C42\u914D\u7F6E\u9519\u8BEF:",e),Promise.reject(e))),this.instance.interceptors.response.use(e=>{const t=e.config;this.concurrencyManager.removePendingRequest(t),t.showLoading&&this.hideLoading();const s=t.metadata?.startTime?Date.now()-t.metadata.startTime:0;return console.log(`\u2705 \u8BF7\u6C42\u6210\u529F: ${t.method?.toUpperCase()} ${t.url} (${s}ms)`),this.handleResponse(e)},async e=>{const t=e.config;return t&&(this.concurrencyManager.removePendingRequest(t),t.showLoading&&this.hideLoading()),this.handleError(e)})}handleResponse(e){const{data:t}=e;if(e.headers["content-type"]?.includes("application/octet-stream"))return e;if(t&&typeof t=="object"&&t.code!==void 0){if(t.code===200||t.success)return t.data!==void 0?t.data:t;throw new Error(t.message||"\u8BF7\u6C42\u5931\u8D25")}return t}async handleError(e){const t=e.config;return a.isCancel(e)?(console.log("\u{1F4CB} \u8BF7\u6C42\u5DF2\u53D6\u6D88:",e.message),Promise.reject(e)):t&&this.shouldRetry(e,t)?this.retryRequest(t):(t?.skipErrorHandler||this.handleGlobalError(e),Promise.reject(e))}shouldRetry(e,t){if(!t.retry||t.retry<=0)return!1;const s=["ECONNABORTED","ENOTFOUND","ECONNREFUSED","ETIMEDOUT"];return!e.response||e.response.status>=500||s.includes(e.code||"")}async retryRequest(e){e.retry=(e.retry||0)-1;const t=e.retryDelay||1e3;return console.log(`\u{1F504} ${t}ms \u540E\u91CD\u8BD5\u8BF7\u6C42, \u5269\u4F59\u91CD\u8BD5\u6B21\u6570: ${e.retry}`),await this.sleep(t),this.instance.request(e)}handleGlobalError(e){const{response:t,message:s}=e;if(t){const{status:u,data:n}=t;switch(u){case 401:console.error("\u{1F510} \u672A\u6388\u6743\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55"),this.handleUnauthorized();break;case 403:console.error("\u{1F6AB} \u6743\u9650\u4E0D\u8DB3");break;case 404:console.error("\u{1F50D} \u8BF7\u6C42\u7684\u8D44\u6E90\u4E0D\u5B58\u5728");break;case 500:console.error("\u{1F4A5} \u670D\u52A1\u5668\u5185\u90E8\u9519\u8BEF");break;default:console.error(`\u274C \u8BF7\u6C42\u9519\u8BEF ${u}:`,n?.message||s)}}else console.error("\u{1F310} \u7F51\u7EDC\u9519\u8BEF:",s)}handleUnauthorized(){this.removeToken(),typeof window<"u"&&(window.location.href="/login")}getToken(){return typeof window<"u"?localStorage.getItem("token")||sessionStorage.getItem("token"):null}removeToken(){typeof window<"u"&&(localStorage.removeItem("token"),sessionStorage.removeItem("token"))}showLoading(){console.log("\u{1F504} \u663E\u793A\u52A0\u8F7D\u72B6\u6001")}hideLoading(){console.log("\u2728 \u9690\u85CF\u52A0\u8F7D\u72B6\u6001")}sleep(e){return new Promise(t=>setTimeout(t,e))}async request(e){return this.concurrencyManager.controlConcurrency(()=>this.instance.request(e))}async get(e,t){return this.request({...t,method:"GET",url:e})}async post(e,t,s){return this.request({...s,method:"POST",url:e,data:t})}async put(e,t,s){return this.request({...s,method:"PUT",url:e,data:t})}async delete(e,t){return this.request({...t,method:"DELETE",url:e})}async patch(e,t,s){return this.request({...s,method:"PATCH",url:e,data:t})}async all(e){return Promise.all(e)}async upload(e,t,s){const u=t instanceof FormData?t:new FormData;return t instanceof File&&u.append("file",t),this.post(e,u,{...s,headers:{"Content-Type":"multipart/form-data",...s?.headers}})}async download(e,t,s){let u,n;typeof t=="string"?(u=t,n=s):n=t;const i=await this.request({...n,url:e,method:"GET",responseType:"blob"}),l=new Blob([i.data]);if(u&&typeof window<"u"){const d=window.URL.createObjectURL(l),r=document.createElement("a");r.href=d,r.download=u,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(d);return}return l}setAuthToken(e){typeof window<"u"&&localStorage.setItem("token",e),this.instance.defaults.headers.common.Authorization=`Bearer ${e}`}clearAuthToken(){this.removeToken(),delete this.instance.defaults.headers.common.Authorization}cancelAllRequests(){this.concurrencyManager.cancelAllRequests()}setDefaultConfig(e){Object.assign(this.defaultConfig,e),Object.assign(this.instance.defaults,e)}addRequestInterceptor(e,t){return this.instance.interceptors.request.use(e,t)}addResponseInterceptor(e,t){return this.instance.interceptors.response.use(e,t)}}return new c({baseURL:process.env.NODE_ENV==="development"?"http://localhost:3000/api":"https://api.example.com",timeout:1e4,retry:3,retryDelay:1e3}),o.HttpClient=c,o.WebSocketClient=g,o}({},axios);
